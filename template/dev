#!/usr/bin/env bash
set -euo pipefail

# üéØ Docker Dev Environment - Main Controller Script
# Your friendly neighborhood container wrangler

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Color codes
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Helper functions
info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
success() { echo -e "${GREEN}‚úì${NC} $1"; }
warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
error() { echo -e "${RED}‚úó${NC} $1"; }

# Ensure we're in the right directory
cd "$SCRIPT_DIR"

# Load environment variables
if [[ -f .env ]]; then
    set -a
    source .env
    set +a
else
    warning ".env file not found, using defaults"
fi

# Container name (from env or default)
CONTAINER_NAME="docker-dev-${PROJECT_NAME:-project}"

# üé¨ Command dispatcher
case "${1:-help}" in
    start)
        info "Starting Docker Dev Environment..."

        # Check SSH agent status before starting
        if [[ -z "${SSH_AUTH_SOCK:-}" ]]; then
            warning "SSH agent not detected (SSH_AUTH_SOCK not set)"
            echo ""
            info "Password-protected SSH keys won't work without ssh-agent"
            info "To enable SSH agent forwarding:"
            echo -e "  ${BLUE}eval \"\$(ssh-agent -s)\"${NC}"
            echo -e "  ${BLUE}ssh-add ~/.ssh/your_key${NC}"
            echo ""
            info "Or use keys without passphrases"
            echo ""
        elif [[ ! -S "${SSH_AUTH_SOCK}" ]]; then
            warning "SSH agent socket not found at: ${SSH_AUTH_SOCK}"
            echo ""
            info "The SSH_AUTH_SOCK variable is set but the socket doesn't exist"
            info "This usually means ssh-agent was restarted or the session ended"
            info "To fix:"
            echo -e "  ${BLUE}eval \"\$(ssh-agent -s)\"${NC}"
            echo -e "  ${BLUE}ssh-add ~/.ssh/your_key${NC}"
            echo ""
            # Unset SSH_AUTH_SOCK to prevent mount failure
            warning "Temporarily unsetting SSH_AUTH_SOCK to prevent mount failure"
            unset SSH_AUTH_SOCK
            echo ""
        else
            success "SSH agent detected - password-protected keys will work!"
        fi

        # Check GitHub CLI authentication
        if [[ -d "${HOME}/.config/gh" ]] && command -v gh &>/dev/null; then
            if gh auth status &>/dev/null 2>&1; then
                success "GitHub CLI authenticated"
            else
                warning "GitHub CLI not authenticated"
                info "Run: ${BLUE}gh auth login${NC} (on host)"
            fi
        elif ! command -v gh &>/dev/null; then
            info "GitHub CLI not installed (optional)"
        else
            warning "GitHub CLI not configured"
            info "Run: ${BLUE}gh auth login${NC} (on host)"
        fi
        echo ""

        docker compose up -d --build
        success "Environment started! Container: $CONTAINER_NAME"
        echo ""
        info "Get a shell: ${BLUE}$0 shell${NC}"
        info "Run Claude Code: ${BLUE}$0 claude${NC}"
        ;;

    stop)
        info "Stopping Docker Dev Environment..."
        docker compose down
        success "Environment stopped"
        ;;

    restart)
        info "Restarting Docker Dev Environment..."

        # Check SSH agent socket before restarting
        if [[ -n "${SSH_AUTH_SOCK:-}" ]] && [[ ! -S "${SSH_AUTH_SOCK}" ]]; then
            warning "SSH agent socket not found at: ${SSH_AUTH_SOCK}"
            info "Unsetting SSH_AUTH_SOCK to prevent mount failure"
            unset SSH_AUTH_SOCK
            echo ""
        fi

        # Use down/up instead of restart to reload environment variables
        # (restart keeps old SSH_AUTH_SOCK which may be stale)
        docker compose down
        docker compose up -d
        success "Environment restarted"
        echo ""
        info "Get a shell: ${BLUE}$0 shell${NC}"
        info "Run Claude Code: ${BLUE}$0 claude${NC}"
        ;;

    shell|sh|bash)
        info "Opening shell in container..."
        docker compose exec devenv /bin/bash -l
        ;;

    claude)
        info "Starting Claude Code with bypass permissions..."

        # Run claude with bypass permissions
        # Use PROJECT_PATH from .env to ensure same path as host (for shared history)
        source .env 2>/dev/null || true
        WORK_DIR="${PROJECT_PATH:-/workspace}"

        # Source nvm from build location (not $HOME which may differ at runtime)
        # Claude Code is installed in the container via npm during docker build
        # npm creates the binary as 'claude' not 'claude-code'
        docker compose exec devenv /bin/bash -c "source /home/\$(whoami)/.nvm/nvm.sh && cd '$WORK_DIR' && claude --dangerously-skip-permissions"
        ;;

    exec|run)
        if [[ -z "${2:-}" ]]; then
            error "Usage: $0 exec <command>"
            exit 1
        fi
        shift
        # Use PROJECT_PATH from .env to ensure same path as host (for shared history)
        source .env 2>/dev/null || true
        WORK_DIR="${PROJECT_PATH:-/workspace}"
        docker compose exec devenv /bin/bash -l -c "cd '$WORK_DIR' && $*"
        ;;

    logs)
        docker compose logs -f devenv
        ;;

    status)
        info "Container status:"
        docker compose ps
        ;;

    clean)
        warning "This will remove the container and all cached volumes"
        read -p "Are you sure? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            info "Cleaning up..."
            docker compose down -v
            success "Cleanup complete"
        else
            info "Cancelled"
        fi
        ;;

    rebuild)
        info "Rebuilding container..."
        docker compose down
        docker compose build --no-cache
        docker compose up -d
        success "Container rebuilt"
        ;;

    help|--help|-h)
        echo "üê≥ Docker Dev Environment - Command Reference"
        echo ""
        echo "Usage: $0 <command>"
        echo ""
        echo "Container Management:"
        echo -e "  ${GREEN}start${NC}       Start the development environment"
        echo -e "  ${GREEN}stop${NC}        Stop the development environment"
        echo -e "  ${GREEN}restart${NC}     Restart the development environment"
        echo -e "  ${GREEN}rebuild${NC}     Rebuild the container from scratch"
        echo -e "  ${GREEN}clean${NC}       Remove container and cached volumes"
        echo -e "  ${GREEN}status${NC}      Show container status"
        echo ""
        echo "Development:"
        echo -e "  ${GREEN}shell${NC}       Get an interactive shell in the container"
        echo -e "  ${GREEN}claude${NC}      Run Claude Code with bypass permissions"
        echo -e "  ${GREEN}exec${NC}        Execute a command in the container"
        echo -e "                ${BLUE}Example: $0 exec python test.py${NC}"
        echo -e "  ${GREEN}logs${NC}        View container logs"
        echo ""
        echo "Examples:"
        echo "  $0 start"
        echo "  $0 shell"
        echo "  $0 claude"
        echo "  $0 exec pytest tests/"
        echo ""
        ;;

    *)
        error "Unknown command: $1"
        echo ""
        info "Run '$0 help' for usage information"
        exit 1
        ;;
esac
