#!/usr/bin/env bash
set -euo pipefail

# üéØ Docker Dev Environment - Main Controller Script
# Your friendly neighborhood container wrangler

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Color codes
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Helper functions
info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
success() { echo -e "${GREEN}‚úì${NC} $1"; }
warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
error() { echo -e "${RED}‚úó${NC} $1"; }

# Ensure we're in the right directory
cd "$SCRIPT_DIR"

# Load environment variables
if [[ -f .env ]]; then
    set -a
    source .env
    set +a
else
    warning ".env file not found, using defaults"
fi

# Container name (from env or default)
CONTAINER_NAME="docker-dev-${PROJECT_NAME:-project}"

# üé¨ Command dispatcher
case "${1:-help}" in
    start)
        info "Starting Docker Dev Environment..."

        # Check SSH agent status before starting
        if [[ -z "${SSH_AUTH_SOCK:-}" ]]; then
            warning "SSH agent not detected (SSH_AUTH_SOCK not set)"
            echo ""
            info "Password-protected SSH keys won't work without ssh-agent"
            info "To enable SSH agent forwarding:"
            echo -e "  ${BLUE}eval \"\$(ssh-agent -s)\"${NC}"
            echo -e "  ${BLUE}ssh-add ~/.ssh/your_key${NC}"
            echo ""
            info "Or use keys without passphrases"
            echo ""
        elif [[ ! -S "${SSH_AUTH_SOCK}" ]]; then
            warning "SSH agent socket not found at: ${SSH_AUTH_SOCK}"
            echo ""
            info "The SSH_AUTH_SOCK variable is set but the socket doesn't exist"
            info "This usually means ssh-agent was restarted or the session ended"
            info "To fix:"
            echo -e "  ${BLUE}eval \"\$(ssh-agent -s)\"${NC}"
            echo -e "  ${BLUE}ssh-add ~/.ssh/your_key${NC}"
            echo ""
            # Unset SSH_AUTH_SOCK to prevent mount failure
            warning "Temporarily unsetting SSH_AUTH_SOCK to prevent mount failure"
            unset SSH_AUTH_SOCK
            echo ""
        else
            success "SSH agent detected - password-protected keys will work!"
        fi

        # Check GitHub CLI authentication
        if [[ -d "${HOME}/.config/gh" ]] && command -v gh &>/dev/null; then
            if gh auth status &>/dev/null 2>&1; then
                success "GitHub CLI authenticated"
            else
                warning "GitHub CLI not authenticated"
                info "Run: ${BLUE}gh auth login${NC} (on host)"
            fi
        elif ! command -v gh &>/dev/null; then
            info "GitHub CLI not installed (optional)"
        else
            warning "GitHub CLI not configured"
            info "Run: ${BLUE}gh auth login${NC} (on host)"
        fi
        echo ""

        docker compose up -d --build
        success "Environment started! Container: $CONTAINER_NAME"
        echo ""
        info "Get a shell: ${BLUE}$0 shell${NC}"
        info "Run Claude Code: ${BLUE}$0 claude${NC}"
        ;;

    stop)
        info "Stopping Docker Dev Environment..."
        docker compose down
        success "Environment stopped"
        ;;

    restart)
        info "Restarting Docker Dev Environment..."

        # Check SSH agent socket before restarting
        if [[ -n "${SSH_AUTH_SOCK:-}" ]] && [[ ! -S "${SSH_AUTH_SOCK}" ]]; then
            warning "SSH agent socket not found at: ${SSH_AUTH_SOCK}"
            info "Unsetting SSH_AUTH_SOCK to prevent mount failure"
            unset SSH_AUTH_SOCK
            echo ""
        fi

        # Use down/up instead of restart to reload environment variables
        # (restart keeps old SSH_AUTH_SOCK which may be stale)
        docker compose down
        docker compose up -d
        success "Environment restarted"
        echo ""
        info "Get a shell: ${BLUE}$0 shell${NC}"
        info "Run Claude Code: ${BLUE}$0 claude${NC}"
        ;;

    shell|sh|bash)
        info "Opening shell in container..."
        docker compose exec devenv /bin/bash -l
        ;;

    claude)
        info "Starting Claude Code with bypass permissions..."

        # Check if claude exists in container
        if ! docker compose exec -T devenv which claude-code &>/dev/null && \
           ! docker compose exec -T devenv which claude &>/dev/null; then
            warning "Claude Code not found in container"

            # Try to find it on host
            CLAUDE_BIN=""
            if command -v claude-code &>/dev/null; then
                CLAUDE_BIN="$(which claude-code)"
            elif command -v claude &>/dev/null; then
                CLAUDE_BIN="$(which claude)"
            else
                error "Claude Code not found on host or in container"
                echo ""
                info "Install Claude Code on your host, then run this command again"
                exit 1
            fi

            # Find the npm global directory with Claude installation
            info "Looking for Claude installation directory..."

            # Try to find node_modules directory
            CLAUDE_MODULE_DIR=""
            if [[ -L "$CLAUDE_BIN" ]]; then
                # Get the directory where the symlink is
                BIN_DIR="$(dirname "$CLAUDE_BIN")"
                # Get the relative target
                CLAUDE_REL="$(readlink "$CLAUDE_BIN" 2>/dev/null)"
                if [[ -n "$CLAUDE_REL" ]]; then
                    # Resolve to absolute path
                    CLAUDE_REAL="$(cd "$BIN_DIR" && cd "$(dirname "$CLAUDE_REL")" && pwd)"
                    if [[ -n "$CLAUDE_REAL" ]] && [[ -d "$CLAUDE_REAL" ]]; then
                        CLAUDE_MODULE_DIR="$CLAUDE_REAL"
                    fi
                fi
            fi

            if [[ -z "$CLAUDE_MODULE_DIR" ]] || [[ ! -d "$CLAUDE_MODULE_DIR" ]]; then
                error "Could not locate Claude Code installation directory"
                echo ""
                warning "Alternative: Run Claude Code from host instead of copying to container"
                info "The container files are accessible from host at: $(pwd)"
                exit 1
            fi

            info "Found Claude module at: $CLAUDE_MODULE_DIR"
            info "Copying Claude Code installation to container..."
            CONTAINER_ID=$(docker compose ps -q devenv)

            # Copy the entire module directory
            docker cp "$CLAUDE_MODULE_DIR" "$CONTAINER_ID:/usr/local/lib/claude-code"

            # Create symlink in container (need sudo for /usr/local/bin)
            docker compose exec -T devenv sudo /bin/bash -c "ln -sf /usr/local/lib/claude-code/cli.js /usr/local/bin/claude && chmod +x /usr/local/bin/claude && chmod +x /usr/local/lib/claude-code/cli.js"

            success "Claude Code installed in container"
        fi

        # Run claude with bypass permissions
        # Use PROJECT_PATH from .env to ensure same path as host
        source .env 2>/dev/null || true
        WORK_DIR="${PROJECT_PATH:-/workspace}"

        if docker compose exec -T devenv which claude-code &>/dev/null; then
            docker compose exec devenv /bin/bash -l -c "cd '$WORK_DIR' && claude-code --dangerously-skip-permissions"
        else
            docker compose exec devenv /bin/bash -l -c "cd '$WORK_DIR' && claude --dangerously-skip-permissions"
        fi
        ;;

    exec|run)
        if [[ -z "${2:-}" ]]; then
            error "Usage: $0 exec <command>"
            exit 1
        fi
        shift
        # Use PROJECT_PATH from .env to ensure same path as host
        source .env 2>/dev/null || true
        WORK_DIR="${PROJECT_PATH:-/workspace}"
        docker compose exec devenv /bin/bash -l -c "cd '$WORK_DIR' && $*"
        ;;

    logs)
        docker compose logs -f devenv
        ;;

    status)
        info "Container status:"
        docker compose ps
        ;;

    clean)
        warning "This will remove the container and all cached volumes"
        read -p "Are you sure? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            info "Cleaning up..."
            docker compose down -v
            success "Cleanup complete"
        else
            info "Cancelled"
        fi
        ;;

    rebuild)
        info "Rebuilding container..."
        docker compose down
        docker compose build --no-cache
        docker compose up -d
        success "Container rebuilt"
        ;;

    help|--help|-h)
        echo "üê≥ Docker Dev Environment - Command Reference"
        echo ""
        echo "Usage: $0 <command>"
        echo ""
        echo "Container Management:"
        echo "  ${GREEN}start${NC}       Start the development environment"
        echo "  ${GREEN}stop${NC}        Stop the development environment"
        echo "  ${GREEN}restart${NC}     Restart the development environment"
        echo "  ${GREEN}rebuild${NC}     Rebuild the container from scratch"
        echo "  ${GREEN}clean${NC}       Remove container and cached volumes"
        echo "  ${GREEN}status${NC}      Show container status"
        echo ""
        echo "Development:"
        echo "  ${GREEN}shell${NC}       Get an interactive shell in the container"
        echo "  ${GREEN}claude${NC}      Run Claude Code with bypass permissions"
        echo "  ${GREEN}exec${NC}        Execute a command in the container"
        echo "                ${BLUE}Example: $0 exec python test.py${NC}"
        echo "  ${GREEN}logs${NC}        View container logs"
        echo ""
        echo "Examples:"
        echo "  $0 start"
        echo "  $0 shell"
        echo "  $0 claude"
        echo "  $0 exec pytest tests/"
        echo ""
        ;;

    *)
        error "Unknown command: $1"
        echo ""
        info "Run '$0 help' for usage information"
        exit 1
        ;;
esac
